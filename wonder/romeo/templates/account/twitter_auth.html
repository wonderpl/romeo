{% extends "base.html" %}

{% block content %}
<div class="container">
  <a href="{{ url_for('.twitter_auth_redirect') }}?callback=twitterAuth" target="_new" class="btn btn-lg btn-primary btn-block">Sign in with Twitter</a>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
function twitterAuth(result) {
  console.log(result);
  if (result.error) {
    alert(result.error);
  } else {
    $.ajax({
      url: "{{ url_for('api.externallogin') }}",
      type: "post",
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify(result.credentials),
      dataType: "json"
    })
      .done(function (data) {
        if (data.account) {
          localStorage.setItem('ls.session_url', data.account.href);  // See setSession in auth.js
          location.href = '/app#/profile';
        } else {
          alert(JSON.stringify(data));
        }
      })
      .fail(function (response) {
        if (response.responseJSON.error == 'registration_required') {
          result.credentials.username = prompt('Please provide your email address (to be used as your username)', '');
          result.credentials.location = currentLocation;
          twitterAuth(result);
        } else if (response.responseJSON.form_errors && response.responseJSON.form_errors.username) {
          result.credentials.username = prompt(response.responseJSON.form_errors.username[0], result.credentials.username);
          twitterAuth(result);
        } else {
          alert(JSON.stringify(response.responseJSON) || 'Oops!');
        }
      });
  }
}
var currentLocation = null;
function setLocation(locationCode) {
  currentLocation = locationCode;
}
</script>
<script src="https://secure.wonderpl.com/ws/location/?_callback=setLocation"></script>
{% endblock %}
